/**
 * Metadata Upload API
 *
 * This module provides endpoints for uploading NFT metadata to Arweave.
 *
 * Required Environment Variables:
 * - SOLANA_RPC_URL: Solana RPC endpoint URL
 *
 * Example Usage:
 * POST /api/upload-metadata
 * {
 *   "name": "Meme NFT",
 *   "description": "A meme generated by AI",
 *   "image": "https://example.com/meme.png",
 *   "attributes": [...]
 * }
 */

import { createUmi } from '@metaplex-foundation/umi-bundle-defaults';
import { irysUploader } from '@metaplex-foundation/umi-uploader-irys';

/**
 * Upload metadata to Arweave for NFT minting
 *
 * This function handles the metadata upload process:
 * 1. Sets up Umi with Irys uploader
 * 2. Uploads metadata to Arweave using Irys
 * 3. Returns the metadata URI
 *
 * @param {Object} req - Express request object
 * @param {Object} req.body - Request body containing NFT metadata
 * @param {Object} res - Express response object
 * @returns {Promise<void>}
 */
export async function uploadMetadata(req, res) {
  try {
    const metadata = req.body;

    // Validate required parameters
    if (!metadata || !metadata.image) {
      return res
        .status(400)
        .json({ error: "Metadata and image URL are required" });
    }

    // 1. Set up Umi instance with Irys uploader
    const rpcUrl = 
      process.env.NEXT_PUBLIC_SOLANA_RPC_URL || 
      "https://api.devnet.solana.com";
    const irysUrl = 
      process.env.NEXT_PUBLIC_IRYS_URL || 
      "https://devnet.irys.xyz";

    const umi = createUmi(rpcUrl)
      .use(irysUploader({
        address: irysUrl,
        network: 'devnet',
      }));

    // 2. Upload metadata to Arweave using Irys
    console.log("Uploading metadata to Arweave...");
    const metadataUri = await umi.uploader.uploadJson(metadata);
    console.log("Metadata uploaded to:", metadataUri);

    // 3. Return response
    res.json({
      success: true,
      metadata_uri: metadataUri,
    });
  } catch (error) {
    console.error("Error uploading metadata:", error);
    res.status(500).json({
      error: "Failed to upload metadata",
      details: error.message,
    });
  }
}
